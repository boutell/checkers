<html>
  <head>
    <title>Checkers</title>
    <style>
      h1 {
        text-align: center;
      }
      main {
        text-align: center;
      }
      #board {
        display: inline-block;
        border: 2px solid gray;
      }
      .row {
        clear: left;
      }
      .cell {
        width: 32px;
        height: 32px;
        float: left;
        padding: 2px;
        border: 2px solid gray;
      }
      .checker {
        display: inline-block;
        border-radius: 16px;
        width: 32px;
        height: 32px;
      }
      .red {
        background-color: red;
      }
      .black {
        background-color: black;
      }
    </style>
  </head>
  <body>
    <h1>Checkers</h1>
    <main>
      <div id="board"></div>
    </main>
    <script>
      (function() {
        const rows = 8, cols = 8;
        const interval = 100;
        const board = [];
        let player = 'red';
        let movesWithoutChange = 0;
        reset();
        function nextTurn() {
          const moves = validMoves(player); 
          if (moves.length) {
            movesWithoutChange = 0;
            move = moves[Math.floor(Math.random() * moves.length)];
            board[move.piece.x][move.piece.y] = null;
            if (move.jumped) {
              board[move.jumped.x][move.jumped.y] = null;
            }
            board[move.x][move.y] = player;
          } else {
            movesWithoutChange++;
          }
          updateBoard();
          if (player === 'red') {
            player = 'black';
          } else {
            player = 'red';
          }
          if (movesWithoutChange === 2) {
            setTimeout(reset, interval * 70);
          } else {
            setTimeout(nextTurn, interval);
          }
        }
        function reset() {
          initBoard();
          setTimeout(nextTurn, interval);
        }
        function initBoard() {
          const boardEl = document.querySelector('#board');
          let html = '';
          for (let x = 0; (x < cols); x++) {
            board[x] = [];
          }
          for (let y = 0; (y < rows); y++) {
            html += '<div class="row">';
            for (let x = 0; (x < cols); x++) {
              board[x][y] = null;
              if ((x + y) % 2) {
                if (y < 3) {
                  board[x][y] = 'black';
                } else if (y >= (rows - 3)) {
                  board[x][y] = 'red';
                }
              }
              html += '<div id="cell' + x + '_' + y + '" class="cell"></div>';
            }
            html += '</div>';
          }
          boardEl.innerHTML = html;
          updateBoard();
        }
        function updateBoard() {
          for (let y = 0; (y < rows); y++) {
            for (let x = 0; (x < cols); x++) {
              const cell = document.querySelector('#cell' + x + '_' + y);
              if (board[x][y]) {
                cell.innerHTML = '<div class="checker ' + board[x][y] + '"></div>';
              } else {
                cell.innerHTML = '';
              }
            }
          }
        }
        function validMoves(player) {
          const pieces = [];
          for (let y = 0; (y < rows); y++) {
            for (let x = 0; (x < cols); x++) {
              if (board[x][y] === player) {
                pieces.push({ x, y }); 
              }
            }
          }
          const moves = [];
          for (piece of pieces) {
            if (player === 'red') {
              test([[-1, -1], [1, -1]]);
            } else {
              test([[-1, 1], [1, 1]]);
            }
            function test(deltas) {
              for (delta of deltas) {
                const dx = delta[0];
                const dy = delta[1];
                const value = probe(dx, dy);
                if (value === false) {
                  // out of bounds
                } else if (value === null) {
                  moves.push({ piece, x: piece.x + dx, y: piece.y + dy });
                } else if (value !== player) {
                  if (probe(dx * 2, dy * 2) === null) {
                    moves.push({ piece, x: piece.x + dx * 2, y: piece.y + dy * 2, jumped: { x: piece.x + dx, y: piece.y + dy } });
                  }
                }
              }
            }
            function probe(dx, dy) {
              if ((piece.x + dx >= 0) && (piece.y + dy >= 0) && (piece.x + dx < cols) && (piece.y + dy < rows)) {
                return board[piece.x + dx][piece.y + dy];
              } else {
                return false;
              }
            }
          }
          // If you can jump, you must jump
          if (moves.find(move => move.jumped)) {
            return moves.filter(move => move.jumped);
          }
          // TODO multi-step moves due to jumping, kings
          return moves;
        }
      })();
    </script>
  </body>
</html>
